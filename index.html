<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>ABC-analyse Shopify</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- XLSX-bibliotheek voor het inlezen van Excel-bestanden -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1220;
      margin: 0;
      padding: 0;
      color: #111827;
    }

    .page-header {
      background: linear-gradient(90deg, #0b3954, #1f6feb);
      color: #e5efff;
      padding: 16px 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.35);
    }

    .page-header h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
    }

    .page-header p {
      margin: 4px 0 0;
      font-size: 13px;
      opacity: 0.9;
    }

    .container {
      max-width: 1300px;
      margin: 20px auto 40px;
      padding: 20px 24px 28px;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.25);
      border: 1px solid #e5e7eb;
    }

    .subtitle {
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 13px;
      color: #4b5563;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 18px;
      align-items: center;
      margin-bottom: 16px;
    }

    .controls label {
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      color: #111827;
    }

    input[type="file"],
    select,
    input[type="text"] {
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      min-width: 220px;
      background: #f9fafb;
      color: #111827;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background-color 0.15s;
    }

    input[type="text"] {
      min-width: 260px;
    }

    input[type="file"]:focus,
    select:focus,
    input[type="text"]:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.25);
      background: #ffffff;
    }

    #statusMessage {
      font-size: 12px;
      color: #374151;
    }

    .info {
      font-size: 12px;
      margin-bottom: 8px;
      color: #4b5563;
    }

    .info strong {
      font-weight: 600;
      color: #111827;
    }

    .hidden {
      display: none;
    }

    .table-scroll-outer {
      margin-top: 12px;
    }

    .table-scroll-top {
      overflow-x: auto;
      overflow-y: hidden;
      height: 12px;
      margin-bottom: 4px;
    }

    .table-scroll-top::-webkit-scrollbar {
      height: 8px;
    }

    .table-scroll-top::-webkit-scrollbar-thumb {
      background: #93c5fd;
      border-radius: 999px;
    }

    .table-scroll-top::-webkit-scrollbar-track {
      background: #e5e7eb;
      border-radius: 999px;
    }

    .table-scroll-inner {
      height: 1px;
    }

    .table-wrapper {
      overflow-x: auto;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
    }

    .table-wrapper::-webkit-scrollbar {
      height: 8px;
    }

    .table-wrapper::-webkit-scrollbar-thumb {
      background: #93c5fd;
      border-radius: 999px;
    }

    .table-wrapper::-webkit-scrollbar-track {
      background: #e5e7eb;
      border-radius: 999px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      background: #fff;
      table-layout: auto;
      min-width: 900px;
    }

    thead {
      background: linear-gradient(90deg, #0b3954, #1f4f9a);
      color: #e5efff;
    }

    th, td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
      white-space: nowrap;
    }

    th {
      position: relative;
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      font-size: 12px;
    }

    th.sorted-asc::after,
    th.sorted-desc::after {
      content: "";
      border: 4px solid transparent;
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
    }

    th.sorted-asc::after {
      border-bottom-color: #bfdbfe;
      margin-top: -3px;
    }

    th.sorted-desc::after {
      border-top-color: #bfdbfe;
      margin-top: 3px;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    tbody tr:hover {
      background: #e0ecff;
    }

    tbody td {
      font-size: 12px;
      color: #111827;
    }

    .section-title {
      margin-top: 20px;
      margin-bottom: 4px;
      font-size: 14px;
      font-weight: 600;
      color: #0b3954;
    }

    .section-subtitle {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 11px;
      color: #4b5563;
    }

    .legend {
      font-size: 11px;
      color: #4b5563;
      margin-top: 12px;
      line-height: 1.4;
    }

    .legend strong {
      color: #111827;
    }

    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 16px;
      }
      th, td {
        padding: 5px 6px;
      }
      .controls {
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <header class="page-header">
    <h1>ABC-analyse Shopify</h1>
    <p>Upload je maandelijkse Excel-export, filter op producttype en krijg direct inzicht in A/B/C-artikelen.</p>
  </header>

  <div class="container">
    <p class="subtitle">
      De applicatie maakt automatisch een ABC-analyse over alle SKU’s. Als je een producttype filtert,
      worden zowel de omzet als de ABC-indeling alléén binnen dat producttype berekend.
    </p>

    <div class="controls">
      <label>
        Excel-bestand (.xlsx / .xls)
        <input type="file" id="excelFileInput" accept=".xlsx,.xls" />
      </label>
      <span id="statusMessage"></span>
    </div>

    <div id="filters" class="controls hidden">
      <label>
        Filter op producttype
        <select id="productTypeFilter">
          <option value="">Alle producttypen</option>
        </select>
      </label>

      <label>
        Zoek op productnaam of SKU
        <input type="text" id="searchInput" placeholder="Typ een naam of SKU..." />
      </label>
    </div>

    <div id="monthsContainer" class="info hidden">
      <strong>Geanalyseerde maanden:</strong>
      <span id="monthsInfo"></span>
    </div>

    <!-- Hoofdresultaten-tabel -->
    <h3 class="section-title">Overzicht ABC-analyse per SKU</h3>
    <p class="section-subtitle">
      Alle SKU’s binnen de huidige selectie (filter &amp; zoekopdracht). Kolommen zijn sorteerbaar.
    </p>

    <div class="table-scroll-outer">
      <div id="tableScrollTop" class="table-scroll-top">
        <div class="table-scroll-inner"></div>
      </div>

      <div class="table-wrapper" id="tableWrapper">
        <table id="resultsTable">
          <thead>
            <tr>
              <th data-column="productTitle" data-type="text">Productnaam</th>
              <th data-column="sku" data-type="text">SKU</th>
              <th data-column="productType" data-type="text">Producttype</th>
              <th data-column="totalUnits" data-type="number">Totaal verkopen</th>
              <th data-column="avgUnitsPerMonth" data-type="number">Gem. verkopen / maand</th>
              <th data-column="daysOfStock" data-type="number">Verwachte dagen voorraad</th>
              <th data-column="stockAvailable" data-type="text">Voorraad aanwezig</th>
              <th data-column="avgAbcScore" data-type="number">Gem. ABC-score (1=A)</th>
              <th data-column="abcTimeline" data-type="text">ABC-beloop over maanden</th>
            </tr>
          </thead>
          <tbody id="resultsBody">
            <tr>
              <td colspan="9">Upload een Excel-bestand om de analyse te starten.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <p class="legend">
      <strong>Legenda hoofdtafel:</strong><br />
      A = SKU’s die samen de eerste 80% van de omzet vormen binnen de gekozen scope
      (alle producten of alleen het gefilterde producttype).<br />
      B = volgende 15% van de omzet (tot 95%).<br />
      C = laatste 5% van de omzet.<br />
      Het ABC-beloop toont de classificatie per maand in chronologische volgorde (bijv. <code>AABBC</code>).<br />
      Een <code>-</code> betekent dat de SKU die maand niet is meegenomen in de ABC-analyse
      (bijvoorbeeld omdat de startvoorraad 0 was).<br />
      <strong>Voorraad aanwezig:</strong> Ja = eindvoorraad meest recente maand &gt; 0, Nee = eindvoorraad meest recente maand = 0.
    </p>

    <!-- Advies-tabel voor bij te bestellen producten -->
    <h3 class="section-title">Advies: bij te bestellen producten (top N)</h3>
    <p class="section-subtitle">
      SKU’s binnen de huidige selectie waarbij geen voorraad meer is in de meest recente maand
      of minder dan 1 maand voorspelde voorraad (&lt; 30 dagen).
    </p>

    <div class="controls" id="restockControls">
      <label>
        Aantal aanbevelingen
        <select id="restockLimitSelect">
          <option value="10">Top 10</option>
          <option value="20" selected>Top 20</option>
          <option value="30">Top 30</option>
          <option value="40">Top 40</option>
          <option value="50">Top 50</option>
        </select>
      </label>
    </div>

    <div class="table-wrapper" id="restockWrapper">
      <table id="restockTable">
        <thead>
          <tr>
            <th data-column="productTitle" data-type="text">Productnaam</th>
            <th data-column="sku" data-type="text">SKU</th>
            <th data-column="productType" data-type="text">Producttype</th>
            <th data-column="stockAvailable" data-type="text">Voorraad aanwezig</th>
            <th data-column="daysOfStock" data-type="number">Verwachte dagen voorraad</th>
            <th data-column="totalUnits" data-type="number">Totaal verkopen</th>
            <th data-column="avgUnitsPerMonth" data-type="number">Gem. verkopen / maand</th>
            <th data-column="avgAbcScore" data-type="number">Gem. ABC-score (1=A)</th>
            <th data-column="monthsInStock" data-type="number">Maanden op voorraad</th>
            <th data-column="abcTimeline" data-type="text">ABC-beloop over maanden</th>
          </tr>
        </thead>
        <tbody id="restockBody">
          <tr>
            <td colspan="10">Nog geen advies beschikbaar. Upload een Excel-bestand om suggesties te zien.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <p class="legend">
      <strong>Legenda adviestafel:</strong><br />
      Een SKU komt in deze lijst als:
      de eindvoorraad in de chronologisch meest recente maand 0 is (geen voorraad),
      of de voorspelde voorraad minder dan 30 dagen is (op basis van gemiddelde maandverkoop).<br />
      Binnen deze set wordt gerangschikt op lage gemiddelde ABC-score (1=A),
      veel maanden met data/voorraad, hoge verkopen (totaal en gemiddeld),
      en een ABC-beloop met veel A-scores in recentere maanden.
    </p>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', function () {
      const state = {
        monthlyData: [],
        allProductTypes: [],
        sortColumn: 'productTitle',
        sortDirection: 'asc',
        searchTerm: '',
        analysisRows: [],
        restockBase: [],
        restockRows: [],
        restockLimit: 20,
        restockSortColumn: null,
        restockSortDirection: 'asc'
      };

      const fileInput = document.getElementById('excelFileInput');
      const monthsInfoEl = document.getElementById('monthsInfo');
      const monthsContainerEl = document.getElementById('monthsContainer');
      const productTypeFilterEl = document.getElementById('productTypeFilter');
      const searchInputEl = document.getElementById('searchInput');
      const resultsBodyEl = document.getElementById('resultsBody');
      const resultsTableEl = document.getElementById('resultsTable');
      const filtersEl = document.getElementById('filters');
      const statusMessageEl = document.getElementById('statusMessage');
      const tableWrapperEl = document.getElementById('tableWrapper');
      const tableScrollTopEl = document.getElementById('tableScrollTop');
      const tableScrollInnerEl = tableScrollTopEl.querySelector('.table-scroll-inner');

      const restockBodyEl = document.getElementById('restockBody');
      const restockTableEl = document.getElementById('restockTable');
      const restockLimitSelectEl = document.getElementById('restockLimitSelect');

      function setStatus(message) {
        statusMessageEl.textContent = message || '';
      }

      function canonicalizeProductType(raw) {
        if (raw == null) return null;
        const str = String(raw).trim();
        if (!str) return null;
        const t = str.toLowerCase();
        if (t === 'nan') return null;

        if (t.includes('compressiesok')) return 'compressiesokken';
        if (t.includes('sneaker')) return 'sneakers';
        if (t.includes('klomp') || t.includes('schoen')) return 'klompen (schoenen)';
        if (t.includes('mok')) return 'mokken';
        if (t.includes('sok')) return 'sokken';

        return str;
      }

      function getUnitPrice(productType) {
        if (!productType) return 0;
        const t = productType.toLowerCase();

        if (t.includes('compressiesok')) return 29.99;
        if (t.includes('sneaker')) return 99.99;
        if (t.includes('klomp') || t.includes('schoen')) return 79.99;
        if (t.includes('mok')) return 14.99;
        if (t.includes('sok')) return 11.99;

        return 0;
      }

      function parseMonthLabel(label) {
        if (!label) return null;
        const str = String(label);
        const parts = str.split(/[-\\/]/);
        if (parts.length === 2) {
          const m = parseInt(parts[0], 10);
          const y = parseInt(parts[1], 10);
          if (!isNaN(m) && !isNaN(y)) return new Date(y, m - 1, 1);
        }
        const d = new Date(str);
        if (!isNaN(d.getTime())) return d;
        return null;
      }

      function formatNumber(value, decimals) {
        if (value == null || !isFinite(value)) {
          return decimals === 0 ? '0' : (0).toLocaleString('nl-NL', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
          });
        }
        return Number(value).toLocaleString('nl-NL', {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals
        });
      }

      function processWorkbook(workbook) {
        const monthlyData = [];

        workbook.SheetNames.forEach(function (name) {
          const sheet = workbook.Sheets[name];
          if (!sheet) return;

          const json = XLSX.utils.sheet_to_json(sheet, { defval: null });
          const entries = [];

          json.forEach(function (row) {
            const skuRaw = row['Product variant SKU'];
            const sku = skuRaw != null ? String(skuRaw).trim() : '';
            if (!sku) return;

            const titleRaw = row['Product title'];
            const productTitle = titleRaw != null ? String(titleRaw).trim() : '';

            const rawType = row['Product type'];
            const productType = canonicalizeProductType(rawType);

            let startingInv = Number(row['Starting inventory units']);
            if (!isFinite(startingInv)) startingInv = 0;

            let endingInv = Number(row['Ending inventory units']);
            if (!isFinite(endingInv)) endingInv = 0;

            let unitsSold = Number(row['Inventory units sold']);
            if (!isFinite(unitsSold)) unitsSold = 0;

            entries.push({
              monthKey: name,
              sku: sku,
              productTitle: productTitle,
              productType: productType,
              startingInv: startingInv,
              endingInv: endingInv,
              unitsSold: unitsSold
            });
          });

          monthlyData.push({
            key: name,
            label: name,
            date: parseMonthLabel(name),
            entries: entries
          });
        });

        monthlyData.sort(function (a, b) {
          if (a.date && b.date) return a.date - b.date;
          if (a.date && !b.date) return -1;
          if (!a.date && b.date) return 1;
          return a.label.localeCompare(b.label, 'nl-NL');
        });

        state.monthlyData = monthlyData;

        if (monthlyData.length > 0) {
          monthsContainerEl.classList.remove('hidden');
          monthsInfoEl.textContent = monthlyData.map(function (m) { return m.label; }).join(', ');
        } else {
          monthsContainerEl.classList.add('hidden');
          monthsInfoEl.textContent = '';
        }

        const typeSet = new Set();
        monthlyData.forEach(function (m) {
          m.entries.forEach(function (e) {
            if (e.productType) typeSet.add(e.productType);
          });
        });
        state.allProductTypes = Array.from(typeSet).sort(function (a, b) {
          return a.localeCompare(b, 'nl-NL');
        });

        productTypeFilterEl.innerHTML = '';
        const optAll = document.createElement('option');
        optAll.value = '';
        optAll.textContent = 'Alle producttypen';
        productTypeFilterEl.appendChild(optAll);

        state.allProductTypes.forEach(function (type) {
          const opt = document.createElement('option');
          opt.value = type;
          opt.textContent = type;
          productTypeFilterEl.appendChild(opt);
        });

        filtersEl.classList.remove('hidden');

        const result = performAnalysis(null);
        state.analysisRows = result.analysisRows;
        state.restockBase = result.restockBase;
        applyRestockLimit();
        updateTable();
      }

      function performAnalysis(filterProductType) {
        const months = state.monthlyData;
        if (!months || months.length === 0) return { analysisRows: [], restockBase: [] };

        const monthKeys = months.map(function (m) { return m.key; });
        const skuInfos = new Map();

        months.forEach(function (month) {
          month.entries.forEach(function (entry) {
            if (filterProductType && entry.productType !== filterProductType) return;

            const sku = entry.sku;
            let info = skuInfos.get(sku);
            if (!info) {
              info = {
                sku: sku,
                productTitle: entry.productTitle || '',
                productType: entry.productType || '',
                totalUnits: 0,
                monthlyUnits: {},
                monthlyEndingInv: {},
                abcByMonth: {}
              };
              skuInfos.set(sku, info);
            } else {
              if (entry.productTitle) info.productTitle = entry.productTitle;
              if (entry.productType) info.productType = entry.productType;
            }

            const units = Number(entry.unitsSold) || 0;
            info.totalUnits += units;
            info.monthlyUnits[month.key] = (info.monthlyUnits[month.key] || 0) + units;

            const endInv = Number(entry.endingInv);
            if (isFinite(endInv)) info.monthlyEndingInv[month.key] = endInv;
          });
        });

        const monthCount = monthKeys.length;

        months.forEach(function (month) {
          const aggregation = new Map();

          month.entries.forEach(function (entry) {
            if (filterProductType && entry.productType !== filterProductType) return;
            if (!skuInfos.has(entry.sku)) return;

            let agg = aggregation.get(entry.sku);
            if (!agg) {
              agg = { startingInv: 0, revenue: 0 };
              aggregation.set(entry.sku, agg);
            }

            const startInv = Number(entry.startingInv) || 0;
            if (startInv > agg.startingInv) agg.startingInv = startInv;

            const units = Number(entry.unitsSold) || 0;
            const price = getUnitPrice(entry.productType);
            agg.revenue += units * price;
          });

          const candidates = [];
          aggregation.forEach(function (agg, sku) {
            if (agg.startingInv > 0) {
              candidates.push({ sku: sku, revenue: agg.revenue });
            }
          });

          if (candidates.length === 0) return;

          let totalRevenue = candidates.reduce(function (sum, c) { return sum + c.revenue; }, 0);

          if (totalRevenue <= 0) {
            candidates.forEach(function (c) {
              const info = skuInfos.get(c.sku);
              if (info) info.abcByMonth[month.key] = 'C';
            });
            return;
          }

          candidates.sort(function (a, b) { return b.revenue - a.revenue; });

          let cumulative = 0;
          candidates.forEach(function (c) {
            cumulative += c.revenue;
            const share = cumulative / totalRevenue;

            let cat;
            if (share <= 0.80) cat = 'A';
            else if (share <= 0.95) cat = 'B';
            else cat = 'C';

            const info = skuInfos.get(c.sku);
            if (info) info.abcByMonth[month.key] = cat;
          });
        });

        const rows = [];
        const restockCandidates = [];

        skuInfos.forEach(function (info) {
          const avgUnitsPerMonth = monthCount > 0 ? info.totalUnits / monthCount : 0;

          let latestEndingInv = null;
          for (let i = monthCount - 1; i >= 0; i--) {
            const key = monthKeys[i];
            if (Object.prototype.hasOwnProperty.call(info.monthlyEndingInv, key)) {
              latestEndingInv = info.monthlyEndingInv[key];
              break;
            }
          }

          let monthsInStock = 0;
          monthKeys.forEach(function (key) {
            const endInv = info.monthlyEndingInv[key];
            const units = info.monthlyUnits[key] || 0;
            if ((endInv != null && endInv > 0) || units > 0) monthsInStock++;
          });

          let daysOfStock = null;
          if (latestEndingInv != null && avgUnitsPerMonth > 0) {
            daysOfStock = (latestEndingInv / avgUnitsPerMonth) * 30;
          }

          const stockAvailable = latestEndingInv != null && latestEndingInv > 0 ? 'Ja' : 'Nee';

          const abcLetters = [];
          const scores = [];
          monthKeys.forEach(function (key) {
            const cat = info.abcByMonth[key];
            if (cat) {
              abcLetters.push(cat);
              if (cat === 'A') scores.push(1);
              else if (cat === 'B') scores.push(2);
              else if (cat === 'C') scores.push(3);
            } else {
              abcLetters.push('-');
            }
          });

          let avgAbcScore = null;
          if (scores.length > 0) {
            const sum = scores.reduce(function (s, v) { return s + v; }, 0);
            avgAbcScore = sum / scores.length;
          }

          let patternScore = 0;
          let lastIdx = -1;
          for (let i = 0; i < abcLetters.length; i++) {
            if (abcLetters[i] !== '-') lastIdx = i;
          }
          for (let i = 0; i < abcLetters.length; i++) {
            const cat = abcLetters[i];
            if (cat === 'A' || cat === 'B' || cat === 'C') {
              const catValue = cat === 'A' ? 3 : cat === 'B' ? 2 : 1;
              let baseWeight = i + 1;
              if (i === lastIdx) {
                baseWeight = baseWeight * 0.5;
              } else if (i >= abcLetters.length - 3) {
                baseWeight = baseWeight * 1.5;
              }
              patternScore += catValue * baseWeight;
            }
          }

          const row = {
            productTitle: info.productTitle,
            sku: info.sku,
            productType: info.productType || '',
            totalUnits: info.totalUnits,
            avgUnitsPerMonth: avgUnitsPerMonth,
            daysOfStock: daysOfStock,
            stockAvailable: stockAvailable,
            avgAbcScore: avgAbcScore,
            abcTimeline: abcLetters.join(''),
            monthsInStock: monthsInStock,
            patternScore: patternScore
          };

          rows.push(row);

          const hasSales = avgUnitsPerMonth > 0 || info.totalUnits > 0;
          const hasAbcInfo = avgAbcScore != null;
          const lowStock = (daysOfStock != null && daysOfStock < 30);
          const noStock = (stockAvailable === 'Nee');

          if (hasSales && hasAbcInfo && (noStock || lowStock)) {
            restockCandidates.push(row);
          }
        });

        restockCandidates.sort(function (a, b) {
          if (a.avgAbcScore != null && b.avgAbcScore != null && a.avgAbcScore !== b.avgAbcScore) {
            return a.avgAbcScore - b.avgAbcScore;
          }
          if (a.patternScore !== b.patternScore) {
            return b.patternScore - a.patternScore;
          }
          if (a.monthsInStock !== b.monthsInStock) {
            return b.monthsInStock - a.monthsInStock;
          }
          if (a.totalUnits !== b.totalUnits) {
            return b.totalUnits - a.totalUnits;
          }
          if (a.avgUnitsPerMonth !== b.avgUnitsPerMonth) {
            return b.avgUnitsPerMonth - a.avgUnitsPerMonth;
          }
          return String(a.productTitle).localeCompare(String(b.productTitle), 'nl-NL');
        });

        return { analysisRows: rows, restockBase: restockCandidates };
      }

      function syncTopScrollWidth() {
        if (!resultsTableEl || !tableScrollInnerEl) return;
        tableScrollInnerEl.style.width = resultsTableEl.scrollWidth + 'px';
      }

      function updateTable() {
        const tbody = resultsBodyEl;
        tbody.innerHTML = '';

        let rows = state.analysisRows.slice();

        const search = state.searchTerm.trim().toLowerCase();
        if (search) {
          rows = rows.filter(function (r) {
            return (r.productTitle && r.productTitle.toLowerCase().includes(search)) ||
                   (r.sku && r.sku.toLowerCase().includes(search));
          });
        }

        const col = state.sortColumn;
        const dir = state.sortDirection === 'asc' ? 1 : -1;

        rows.sort(function (a, b) {
          const va = a[col];
          const vb = b[col];

          if (va == null && vb == null) return 0;
          if (va == null) return 1;
          if (vb == null) return -1;

          if (
            col === 'productTitle' ||
            col === 'sku' ||
            col === 'productType' ||
            col === 'abcTimeline' ||
            col === 'stockAvailable'
          ) {
            return String(va).localeCompare(String(vb), 'nl-NL') * dir;
          } else {
            const na = Number(va);
            const nb = Number(vb);
            if (isNaN(na) && isNaN(nb)) return 0;
            if (isNaN(na)) return 1;
            if (isNaN(nb)) return -1;
            if (na < nb) return -1 * dir;
            if (na > nb) return 1 * dir;
            return 0;
          }
        });

        if (rows.length === 0) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 9;
          td.textContent = 'Geen resultaten voor de huidige filters.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          syncTopScrollWidth();
          return;
        }

        rows.forEach(function (r) {
          const tr = document.createElement('tr');

          const tdTitle = document.createElement('td');
          tdTitle.textContent = r.productTitle || '';
          tr.appendChild(tdTitle);

          const tdSku = document.createElement('td');
          tdSku.textContent = r.sku || '';
          tr.appendChild(tdSku);

          const tdType = document.createElement('td');
          tdType.textContent = r.productType || '';
          tr.appendChild(tdType);

          const tdTotal = document.createElement('td');
          tdTotal.textContent = formatNumber(r.totalUnits, 0);
          tr.appendChild(tdTotal);

          const tdAvg = document.createElement('td');
          tdAvg.textContent = formatNumber(r.avgUnitsPerMonth, 2);
          tr.appendChild(tdAvg);

          const tdDays = document.createElement('td');
          tdDays.textContent = r.daysOfStock != null ? formatNumber(r.daysOfStock, 1) : '—';
          tr.appendChild(tdDays);

          const tdStock = document.createElement('td');
          tdStock.textContent = r.stockAvailable || 'Nee';
          tr.appendChild(tdStock);

          const tdScore = document.createElement('td');
          tdScore.textContent = r.avgAbcScore != null ? formatNumber(r.avgAbcScore, 2) : '—';
          tr.appendChild(tdScore);

          const tdTimeline = document.createElement('td');
          tdTimeline.textContent = r.abcTimeline || '';
          tr.appendChild(tdTimeline);

          tbody.appendChild(tr);
        });

        syncTopScrollWidth();
      }

      function applyRestockLimit() {
        const base = state.restockBase || [];
        state.restockRows = base.slice(0, state.restockLimit);
        updateRestockTable();
      }

      function updateRestockTable() {
        const tbody = restockBodyEl;
        tbody.innerHTML = '';

        let rows = state.restockRows.slice();

        const search = state.searchTerm.trim().toLowerCase();
        if (search) {
          rows = rows.filter(function (r) {
            return (r.productTitle && r.productTitle.toLowerCase().includes(search)) ||
                   (r.sku && r.sku.toLowerCase().includes(search));
          });
        }

        const col = state.restockSortColumn;
        const dir = state.restockSortDirection === 'asc' ? 1 : -1;

        if (col) {
          rows.sort(function (a, b) {
            const va = a[col];
            const vb = b[col];

            if (va == null && vb == null) return 0;
            if (va == null) return 1;
            if (vb == null) return -1;

            if (
              col === 'productTitle' ||
              col === 'sku' ||
              col === 'productType' ||
              col === 'stockAvailable' ||
              col === 'abcTimeline'
            ) {
              return String(va).localeCompare(String(vb), 'nl-NL') * dir;
            } else {
              const na = Number(va);
              const nb = Number(vb);
              if (isNaN(na) && isNaN(nb)) return 0;
              if (isNaN(na)) return 1;
              if (isNaN(nb)) return -1;
              if (na < nb) return -1 * dir;
              if (na > nb) return 1 * dir;
              return 0;
            }
          });
        }

        if (rows.length === 0) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 10;
          td.textContent = 'Geen bij te bestellen producten binnen de huidige selectie.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        rows.forEach(function (r) {
          const tr = document.createElement('tr');

          const tdTitle = document.createElement('td');
          tdTitle.textContent = r.productTitle || '';
          tr.appendChild(tdTitle);

          const tdSku = document.createElement('td');
          tdSku.textContent = r.sku || '';
          tr.appendChild(tdSku);

          const tdType = document.createElement('td');
          tdType.textContent = r.productType || '';
          tr.appendChild(tdType);

          const tdStock = document.createElement('td');
          tdStock.textContent = r.stockAvailable || 'Nee';
          tr.appendChild(tdStock);

          const tdDays = document.createElement('td');
          tdDays.textContent = r.daysOfStock != null ? formatNumber(r.daysOfStock, 1) : '—';
          tr.appendChild(tdDays);

          const tdTotal = document.createElement('td');
          tdTotal.textContent = formatNumber(r.totalUnits, 0);
          tr.appendChild(tdTotal);

          const tdAvg = document.createElement('td');
          tdAvg.textContent = formatNumber(r.avgUnitsPerMonth, 2);
          tr.appendChild(tdAvg);

          const tdScore = document.createElement('td');
          tdScore.textContent = r.avgAbcScore != null ? formatNumber(r.avgAbcScore, 2) : '—';
          tr.appendChild(tdScore);

          const tdMonths = document.createElement('td');
          tdMonths.textContent = r.monthsInStock != null ? formatNumber(r.monthsInStock, 0) : '0';
          tr.appendChild(tdMonths);

          const tdTimeline = document.createElement('td');
          tdTimeline.textContent = r.abcTimeline || '';
          tr.appendChild(tdTimeline);

          tbody.appendChild(tr);
        });
      }

      fileInput.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;
        setStatus('Bezig met inlezen van het Excel-bestand...');

        const reader = new FileReader();
        reader.onload = function (evt) {
          try {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            processWorkbook(workbook);
            setStatus('Bestand geladen: ' + file.name);
          } catch (err) {
            console.error(err);
            setStatus('Fout bij het inlezen van het bestand: ' + err.message);
          }
        };
        reader.readAsArrayBuffer(file);
      });

      productTypeFilterEl.addEventListener('change', function () {
        const filterType = this.value || null;
        const result = performAnalysis(filterType);
        state.analysisRows = result.analysisRows;
        state.restockBase = result.restockBase;
        applyRestockLimit();
        updateTable();
      });

      searchInputEl.addEventListener('input', function () {
        state.searchTerm = this.value || '';
        updateTable();
        updateRestockTable();
      });

      const headerCells = resultsTableEl.querySelectorAll('thead th');
      headerCells.forEach(function (th) {
        th.addEventListener('click', function () {
          const col = this.getAttribute('data-column');
          const type = this.getAttribute('data-type') || 'text';
          if (!col) return;

          if (state.sortColumn === col) {
            state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            state.sortColumn = col;
            state.sortDirection = type === 'number' ? 'desc' : 'asc';
          }

          headerCells.forEach(function (h) {
            h.classList.remove('sorted-asc', 'sorted-desc');
          });
          this.classList.add(state.sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');

          updateTable();
        });
      });

      const restockHeaderCells = restockTableEl.querySelectorAll('thead th');
      restockHeaderCells.forEach(function (th) {
        th.addEventListener('click', function () {
          const col = this.getAttribute('data-column');
          const type = this.getAttribute('data-type') || 'text';
          if (!col) return;

          if (state.restockSortColumn === col) {
            state.restockSortDirection = state.restockSortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            state.restockSortColumn = col;
            state.restockSortDirection = type === 'number' ? 'desc' : 'asc';
          }

          restockHeaderCells.forEach(function (h) {
            h.classList.remove('sorted-asc', 'sorted-desc');
          });
          this.classList.add(state.restockSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');

          updateRestockTable();
        });
      });

      restockLimitSelectEl.addEventListener('change', function () {
        const val = parseInt(this.value, 10);
        if (!isNaN(val) && val > 0) {
          state.restockLimit = val;
          applyRestockLimit();
        }
      });

      let isSyncingTop = false;
      let isSyncingBottom = false;

      tableScrollTopEl.addEventListener('scroll', function () {
        if (isSyncingTop) return;
        isSyncingBottom = true;
        tableWrapperEl.scrollLeft = tableScrollTopEl.scrollLeft;
        isSyncingBottom = false;
      });

      tableWrapperEl.addEventListener('scroll', function () {
        if (isSyncingBottom) return;
        isSyncingTop = true;
        tableScrollTopEl.scrollLeft = tableWrapperEl.scrollLeft;
        isSyncingTop = false;
      });

      window.addEventListener('resize', function () {
        syncTopScrollWidth();
      });

      syncTopScrollWidth();
    });
  </script>
</body>
</html>
